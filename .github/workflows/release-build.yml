name: ðŸš€ Build and Release Executables

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ (å¦‚ v1.1.0)

jobs:
  build-windows:
    name: ðŸªŸ Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ðŸ”¨ Build Windows executable
      run: |
        python tools/build/github_build.py
        
    - name: ðŸ“‹ Get version
      id: get_version
      run: |
        $version = "${{ github.ref_name }}"
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        
    - name: ðŸ“¦ Prepare release artifacts
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir release-artifacts
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        copy "tools\build\dist\vmm-sandbox.exe" "release-artifacts\vmm-sandbox-windows-${{ steps.get_version.outputs.VERSION }}.exe"
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶ç¤ºä¾‹
        copy "config.yaml.example" "release-artifacts\config.yaml.example"
        
        # å¤åˆ¶README
        copy "README.md" "release-artifacts\README.md"
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
        echo "# VMM Sandbox Analysis System - Windows Release" > release-artifacts\USAGE.md
        echo "" >> release-artifacts\USAGE.md
        echo "## Quick Start" >> release-artifacts\USAGE.md
        echo "1. Copy config.yaml.example to config.yaml" >> release-artifacts\USAGE.md
        echo "2. Edit config.yaml with your settings" >> release-artifacts\USAGE.md
        echo "3. Run vmm-sandbox-windows-${{ steps.get_version.outputs.VERSION }}.exe" >> release-artifacts\USAGE.md
        echo "4. Access web interface at http://localhost:8000" >> release-artifacts\USAGE.md
        
    - name: ðŸ“¤ Upload Windows artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-executable
        path: release-artifacts/

  build-linux:
    name: ðŸ§ Build Linux Executable
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ðŸ”¨ Build Linux executable
      run: |
        python tools/build/github_build.py
        
    - name: ðŸ“‹ Get version
      id: get_version
      run: |
        echo "VERSION=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        
    - name: ðŸ“¦ Prepare release artifacts
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release-artifacts
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp "tools/build/dist/vmm-sandbox" "release-artifacts/vmm-sandbox-linux-${{ steps.get_version.outputs.VERSION }}"
        chmod +x "release-artifacts/vmm-sandbox-linux-${{ steps.get_version.outputs.VERSION }}"
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶ç¤ºä¾‹
        cp "config.yaml.example" "release-artifacts/config.yaml.example"
        
        # å¤åˆ¶README
        cp "README.md" "release-artifacts/README.md"
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
        cat > release-artifacts/USAGE.md << EOF
        # VMM Sandbox Analysis System - Linux Release
        
        ## Quick Start
        1. Copy config.yaml.example to config.yaml
        2. Edit config.yaml with your settings
        3. Run ./vmm-sandbox-linux-${{ steps.get_version.outputs.VERSION }}
        4. Access web interface at http://localhost:8000
        
        ## Requirements
        - Linux x86_64
        - Virtualization support (VirtualBox, KVM, etc.)
        - Network access for sample analysis
        EOF
        
    - name: ðŸ“¤ Upload Linux artifacts
      uses: actions/upload-artifact@v3
      with:
        name: linux-executable
        path: release-artifacts/

  create-release:
    name: ðŸŽ‰ Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download Windows artifacts
      uses: actions/download-artifact@v3
      with:
        name: windows-executable
        path: windows-release/
        
    - name: ðŸ“¥ Download Linux artifacts
      uses: actions/download-artifact@v3
      with:
        name: linux-executable
        path: linux-release/
        
    - name: ðŸ“‹ Get version and changelog
      id: get_info
      run: |
        VERSION=${{ github.ref_name }}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        cat > RELEASE_NOTES.md << EOF
        # ðŸ›¡ï¸ VMM Sandbox Analysis System $VERSION
        
        ## ðŸ“¦ Downloads
        
        ### Windows
        - **vmm-sandbox-windows-$VERSION.exe** - Windows executable (x64)
        
        ### Linux  
        - **vmm-sandbox-linux-$VERSION** - Linux executable (x64)
        
        ## ðŸš€ Quick Start
        
        1. Download the appropriate executable for your platform
        2. Copy \`config.yaml.example\` to \`config.yaml\`
        3. Configure your sandbox settings in \`config.yaml\`
        4. Run the executable
        5. Access the web interface at http://localhost:8000
        
        ## ðŸ”§ Features
        
        - ðŸ›¡ï¸ Advanced malware sandbox analysis
        - ðŸ” Multi-engine threat detection
        - ðŸ“Š Behavioral analysis with Sysmon integration
        - âš¡ Parallel processing capabilities
        - ðŸŒ RESTful API interface
        - ðŸ“ˆ Real-time monitoring and reporting
        
        ## ðŸ“‹ System Requirements
        
        ### Windows
        - Windows 10/11 (x64)
        - 16GB+ RAM recommended
        - Virtualization platform (VirtualBox, Hyper-V)
        
        ### Linux
        - Linux x86_64 (Ubuntu 20.04+, CentOS 8+)
        - 16GB+ RAM recommended  
        - Virtualization support (KVM, VirtualBox)
        
        ## ðŸ†˜ Support
        
        - ðŸ“– Documentation: [README.md](README.md)
        - ðŸ› Issues: [GitHub Issues](https://github.com/zcyberseclab/vmm-sandbox/issues)
        - ðŸ’¬ Discussions: [GitHub Discussions](https://github.com/zcyberseclab/vmm-sandbox/discussions)
        
        ---
        
        **Full Changelog**: https://github.com/zcyberseclab/vmm-sandbox/compare/v1.0.0...$VERSION
        EOF
        
    - name: ðŸŽ‰ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_info.outputs.VERSION }}
        name: "ðŸ›¡ï¸ VMM Sandbox ${{ steps.get_info.outputs.VERSION }}"
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
        files: |
          windows-release/*
          linux-release/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
